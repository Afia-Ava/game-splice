<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speed Racer - High-Speed Racing Adventure</title>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        background: #000000;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: 'Courier New', monospace;
        color: white;
        overflow: hidden;
      }

      .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: black;
        color: white;
        border: 2px solid white;
        padding: 10px 20px;
        text-decoration: none;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .back-button:hover {
        background: white;
        color: black;
        border: 2px solid black;
      }

      .game-container {
        display: flex;
        gap: 20px;
        align-items: center;
        justify-content: center;
        margin-top: -20px;
        position: relative;
      }

      #gameCanvas {
        border: 2px solid white;
        background: #333333;
        cursor: pointer;
      }

      .game-info {
        position: fixed;
        top: 15px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        z-index: 100;
      }

      .score {
        background: #000000;
        border: 2px solid white;
        padding: 6px 8px;
        text-align: left;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        min-width: 90px;
        font-size: 0.7rem;
        line-height: 1.2;
      }

      .controls {
        background: #000000;
        border: 2px solid white;
        padding: 5px 6px;
        font-family: 'Courier New', monospace;
        font-size: 0.6rem;
        line-height: 1.2;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        max-width: 140px;
      }

      .game-over {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid white;
        padding: 30px;
        text-align: center;
        font-family: 'Courier New', monospace;
        z-index: 200;
        display: none;
      }

      .game-over h2 {
        color: #ff4444;
        font-size: 2rem;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .restart-btn {
        background: black;
        color: white;
        border: 2px solid white;
        padding: 15px 30px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
      }

      .restart-btn:hover {
        background: white;
        color: black;
        border: 2px solid black;
      }

      .start-screen {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid white;
        padding: 40px;
        text-align: center;
        font-family: 'Courier New', monospace;
        z-index: 300;
      }

      .start-screen h1 {
        color: #ff6600;
        font-size: 3rem;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .start-screen p {
        font-size: 1.2rem;
        margin-bottom: 30px;
        color: #ffffff;
      }

      .shop {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid white;
        padding: 30px;
        text-align: center;
        font-family: 'Courier New', monospace;
        z-index: 200;
        display: none;
        min-width: 300px;
      }

      .shop h2 {
        color: #00ff00;
        font-size: 1.5rem;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .shop-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 0;
        padding: 10px;
        border: 1px solid white;
      }

      .upgrade-btn {
        background: black;
        color: white;
        border: 2px solid white;
        padding: 5px 15px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8rem;
      }

      .upgrade-btn:hover {
        background: white;
        color: black;
        border: 2px solid black;
      }

      .upgrade-btn:disabled {
        background: #333;
        color: #666;
        border: 2px solid #666;
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        .game-info {
          position: fixed;
          top: 10px;
          right: 5px;
          gap: 4px;
        }

        .score,
        .controls {
          font-size: 0.6rem;
          padding: 4px 6px;
          min-width: 80px;
          max-width: 120px;
        }

        #gameCanvas {
          width: 95vw;
          height: 70vh;
        }
      }
    </style>
  </head>
  <body>
    <a href="index.html" class="back-button">Back</a>

    <div class="game-container">
      <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>

    <div class="game-info">
      <div class="score">
        Score: <span id="scoreValue">0</span><br />
        Coins: <span id="coinsValue">0</span><br />
        Best: <span id="bestValue">0</span><br />
        Speed: <span id="speedValue">0</span> mph
      </div>
      <div class="controls">
        A/D: Steer<br />
        S: Shop<br />
        Space: Boost<br />
        R: Restart
      </div>
    </div>

    <div class="start-screen" id="startScreen">
      <h1>üèéÔ∏è Speed Racer</h1>
      <p>Race through traffic and collect coins!</p>
      <p>Use coins to upgrade your car in the shop!</p>
      <button class="restart-btn" onclick="startGame()">Start Racing</button>
    </div>

    <div class="game-over" id="gameOverScreen">
      <h2>Race Over</h2>
      <p>Final Score: <span id="finalScore">0</span></p>
      <p>Distance: <span id="finalDistance">0</span>m</p>
      <p>Coins Earned: <span id="coinsEarned">0</span></p>
      <p id="newRecord" style="color: #00ff00; display: none">
        New Best Score!
      </p>
      <button class="restart-btn" onclick="restartGame()">Race Again</button>
      <button class="restart-btn" onclick="openShop()">Shop</button>
    </div>

    <div class="shop" id="shopScreen">
      <h2>üîß Car Shop</h2>
      <p>Coins: <span id="shopCoins">0</span></p>
      <div class="shop-item">
        <span>Speed Boost (Level <span id="speedLevel">1</span>)</span>
        <button class="upgrade-btn" onclick="buyUpgrade('speed')" id="speedBtn">
          Buy (100)
        </button>
      </div>
      <div class="shop-item">
        <span>Handling (Level <span id="handlingLevel">1</span>)</span>
        <button
          class="upgrade-btn"
          onclick="buyUpgrade('handling')"
          id="handlingBtn"
        >
          Buy (150)
        </button>
      </div>
      <div class="shop-item">
        <span>Boost Power (Level <span id="boostLevel">1</span>)</span>
        <button class="upgrade-btn" onclick="buyUpgrade('boost')" id="boostBtn">
          Buy (200)
        </button>
      </div>
      <button class="restart-btn" onclick="closeShop()">Close Shop</button>
    </div>

    <script>
      if (typeof window.firebaseConfig === 'undefined') {
        console.error(
          'Firebase configuration not loaded. Please check firebase-config.js'
        );
      }

      let auth,
        db,
        currentUser = null;
      try {
        firebase.initializeApp(window.firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        console.log('Firebase initialized successfully in Speed Racer');
      } catch (error) {
        console.error('Firebase initialization error in Speed Racer:', error);
      }

      auth.onAuthStateChanged(user => {
        currentUser = user;
      });

      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');

      let audioContext;
      let masterGain;

      function initAudio() {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          masterGain = audioContext.createGain();
          masterGain.gain.value = 0.25;
          masterGain.connect(audioContext.destination);
        }
      }

      function playEngineSound() {
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        const baseFreq = 80 + player.speed * 15;
        const boostFreq = player.boost ? baseFreq * 1.3 : baseFreq;

        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(
          boostFreq,
          audioContext.currentTime
        );
        oscillator.frequency.exponentialRampToValueAtTime(
          boostFreq + 10,
          audioContext.currentTime + 0.1
        );

        gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.1
        );

        oscillator.connect(gainNode);
        gainNode.connect(masterGain);

        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);
      }

      function playBoostSound() {
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(
          400,
          audioContext.currentTime + 0.2
        );
        gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.2
        );

        oscillator.connect(gainNode);
        gainNode.connect(masterGain);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.2);
      }
      function playCoinSound() {
        initAudio();
        const frequencies = [523, 659, 784];
        frequencies.forEach((freq, index) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(
            freq,
            audioContext.currentTime + index * 0.03
          );

          gainNode.gain.setValueAtTime(
            0.15,
            audioContext.currentTime + index * 0.03
          );
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + index * 0.03 + 0.15
          );

          oscillator.connect(gainNode);
          gainNode.connect(masterGain);
          oscillator.start(audioContext.currentTime + index * 0.03);
          oscillator.stop(audioContext.currentTime + index * 0.03 + 0.15);
        });
      }

      function playCrashSound() {
        initAudio();
        for (let i = 0; i < 5; i++) {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.type = 'sawtooth';
          oscillator.frequency.setValueAtTime(
            Math.random() * 200 + 100,
            audioContext.currentTime
          );
          oscillator.frequency.exponentialRampToValueAtTime(
            50,
            audioContext.currentTime + 0.8
          );

          gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + 0.8
          );

          oscillator.connect(gainNode);
          gainNode.connect(masterGain);

          oscillator.start(audioContext.currentTime + i * 0.02);
          oscillator.stop(audioContext.currentTime + 0.8);
        }
      }

      function playStartSound() {
        initAudio();
        const frequencies = [262, 330, 392, 523, 659];

        frequencies.forEach((freq, index) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(
            freq,
            audioContext.currentTime + index * 0.1
          );

          gainNode.gain.setValueAtTime(
            0.12,
            audioContext.currentTime + index * 0.1
          );
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + index * 0.1 + 0.3
          );

          oscillator.connect(gainNode);
          gainNode.connect(masterGain);

          oscillator.start(audioContext.currentTime + index * 0.1);
          oscillator.stop(audioContext.currentTime + index * 0.1 + 0.3);
        });
      }

      function playUpgradeSound() {
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(
          800,
          audioContext.currentTime + 0.3
        );

        gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.3
        );

        oscillator.connect(gainNode);
        gainNode.connect(masterGain);

        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.3);
      }

      let gameStarted = false;
      let gameRunning = false;
      let score = 0;
      let coins = 0;
      let totalCoins = parseInt(localStorage.getItem('speedRacerCoins')) || 0;
      let bestScore = localStorage.getItem('speedRacerBest') || 0;
      let distance = 0;
      let frameCount = 0;

      let upgrades = {
        speed: parseInt(localStorage.getItem('speedRacerSpeedLevel')) || 1,
        handling:
          parseInt(localStorage.getItem('speedRacerHandlingLevel')) || 1,
        boost: parseInt(localStorage.getItem('speedRacerBoostLevel')) || 1,
      };

      const player = {
        x: canvas.width / 2 - 15,
        y: canvas.height - 80,
        width: 30,
        height: 50,
        speed: 0,
        maxSpeed: 3 + upgrades.speed * 0.5,
        acceleration: 0.1,
        friction: 0.05,
        lateralSpeed: 4 + upgrades.handling * 0.5,
        boost: false,
        boostPower: 1.5 + upgrades.boost * 0.3,
        boostEnergy: 100,
        maxBoostEnergy: 100,
      };

      let cars = [];
      let coinItems = [];
      let particles = [];
      let roadOffset = 0;

      const keys = {
        left: false,
        right: false,
        boost: false,
      };

      const lanes = [
        canvas.width / 2 - 90,
        canvas.width / 2 - 30,
        canvas.width / 2 + 30,
        canvas.width / 2 + 90,
      ];

      canvas.addEventListener('click', () => {
        if (!gameStarted) {
          startGame();
        }
      });

      document.addEventListener('keydown', e => {
        if (e.key.toLowerCase() === 'a' || e.key === 'ArrowLeft') {
          keys.left = true;
        }
        if (e.key.toLowerCase() === 'd' || e.key === 'ArrowRight') {
          keys.right = true;
        }
        if (e.code === 'Space') {
          e.preventDefault();
          keys.boost = true;
        }
        if (e.key.toLowerCase() === 'r') {
          restartGame();
        }
        if (e.key.toLowerCase() === 's') {
          if (gameRunning) {
            pauseGame();
            openShop();
          }
        }
      });

      document.addEventListener('keyup', e => {
        if (e.key.toLowerCase() === 'a' || e.key === 'ArrowLeft') {
          keys.left = false;
        }
        if (e.key.toLowerCase() === 'd' || e.key === 'ArrowRight') {
          keys.right = false;
        }
        if (e.code === 'Space') {
          keys.boost = false;
        }
      });

      function startGame() {
        gameStarted = true;
        gameRunning = true;
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('bestValue').textContent = bestScore;
        document.getElementById('coinsValue').textContent = totalCoins;
        playStartSound();
        resetGame();
      }

      function resetGame() {
        player.x = canvas.width / 2 - 15;
        player.y = canvas.height - 80;
        player.speed = 0;
        player.boostEnergy = player.maxBoostEnergy;
        score = 0;
        coins = 0;
        distance = 0;
        cars = [];
        coinItems = [];
        particles = [];
        frameCount = 0;
        roadOffset = 0;
        player.maxSpeed = 3 + upgrades.speed * 0.5;
        player.lateralSpeed = 4 + upgrades.handling * 0.5;
        player.boostPower = 1.5 + upgrades.boost * 0.3;
      }

      function createCar() {
        const blockedLanes = [];
        const safeDistance = 150;
        for (let i = 0; i < lanes.length; i++) {
          for (let car of cars) {
            if (
              Math.abs(car.x - (lanes[i] - 15)) < 20 &&
              car.y > -safeDistance &&
              car.y < safeDistance
            ) {
              blockedLanes.push(i);
              break;
            }
          }
        }

        if (blockedLanes.length >= 3) {
          return;
        }
        const availableLanes = [];
        for (let i = 0; i < lanes.length; i++) {
          if (!blockedLanes.includes(i)) {
            availableLanes.push(i);
          }
        }

        let selectedLane;
        if (availableLanes.length > 0) {
          selectedLane =
            availableLanes[Math.floor(Math.random() * availableLanes.length)];
        } else {
          selectedLane = Math.floor(Math.random() * lanes.length);
        }

        const carColors = [
          '#ff0000',
          '#0000ff',
          '#00ff00',
          '#ffff00',
          '#ff00ff',
        ];

        cars.push({
          x: lanes[selectedLane] - 15,
          y: -60,
          width: 30,
          height: 50,
          speed: Math.random() * 2 + 1,
          color: carColors[Math.floor(Math.random() * carColors.length)],
        });
      }

      function createCoin() {
        const lane = Math.floor(Math.random() * lanes.length);
        coinItems.push({
          x: lanes[lane],
          y: -20,
          width: 20,
          height: 20,
          speed: 2,
          rotation: 0,
        });
      }

      function createParticles(x, y, color = '#ffffff') {
        for (let i = 0; i < 8; i++) {
          particles.push({
            x: x,
            y: y,
            vx: Math.random() * 6 - 3,
            vy: Math.random() * 6 - 3,
            life: 30,
            maxLife: 30,
            size: Math.random() * 4 + 2,
            color: color,
          });
        }
      }

      function updatePlayer() {
        if (!gameRunning) return;
        const roadLeft = canvas.width / 2 - 120;
        const roadRight = canvas.width / 2 + 115;
        if (keys.left && player.x > roadLeft + 5) {
          player.x -= player.lateralSpeed;
        }
        if (keys.right && player.x + player.width < roadRight - 5) {
          player.x += player.lateralSpeed;
        }

        if (keys.boost && player.boostEnergy > 0) {
          player.boost = true;
          player.boostEnergy -= 2;
          createParticles(
            player.x + player.width / 2,
            player.y + player.height,
            '#ff6600'
          );
          if (frameCount % 10 === 0) {
            playBoostSound();
          }
        } else {
          player.boost = false;
          if (player.boostEnergy < player.maxBoostEnergy) {
            player.boostEnergy += 0.5;
          }
        }

        if (player.speed < player.maxSpeed) {
          player.speed += player.acceleration;
        }

        const effectiveSpeed = player.boost
          ? player.speed * player.boostPower
          : player.speed;

        distance += effectiveSpeed;
        score += Math.floor(effectiveSpeed * 10);
      }

      function updateCars() {
        if (!gameRunning) return;

        for (let i = cars.length - 1; i >= 0; i--) {
          const car = cars[i];
          car.y += car.speed + player.speed;
          if (
            player.x < car.x + car.width &&
            player.x + player.width > car.x &&
            player.y < car.y + car.height &&
            player.y + player.height > car.y
          ) {
            playCrashSound();
            gameOver();
            return;
          }
          if (car.y > canvas.height) {
            cars.splice(i, 1);
          }
        }

        const baseSpawnRate = 0.015;
        const difficultyMultiplier = Math.min(distance * 0.00001, 0.01);
        const spawnRate = baseSpawnRate + difficultyMultiplier;
        if (cars.length < 8 && Math.random() < spawnRate) {
          createCar();
        }
      }

      function updateCoins() {
        if (!gameRunning) return;
        for (let i = coinItems.length - 1; i >= 0; i--) {
          const coin = coinItems[i];
          coin.y += coin.speed + player.speed;
          coin.rotation += 0.1;
          if (
            player.x < coin.x + coin.width &&
            player.x + player.width > coin.x &&
            player.y < coin.y + coin.height &&
            player.y + player.height > coin.y
          ) {
            coins++;
            totalCoins++;
            score += 50;
            playCoinSound();
            createParticles(coin.x, coin.y, '#ffdd00');
            coinItems.splice(i, 1);
            continue;
          }
          if (coin.y > canvas.height) {
            coinItems.splice(i, 1);
          }
        }
        if (Math.random() < 0.01) {
          createCoin();
        }
      }

      function updateParticles() {
        for (let i = particles.length - 1; i >= 0; i--) {
          const particle = particles[i];
          particle.x += particle.vx;
          particle.y += particle.vy;
          particle.life--;
          if (particle.life <= 0) {
            particles.splice(i, 1);
          }
        }
      }

      function drawRoad() {
        ctx.fillStyle = '#444444';
        ctx.fillRect(canvas.width / 2 - 120, 0, 240, canvas.height);
        ctx.fillStyle = '#ffffff';
        const lineHeight = 30;
        const lineGap = 20;
        roadOffset += player.speed * 2;
        if (roadOffset > lineHeight + lineGap) {
          roadOffset = 0;
        }
        for (
          let y = -lineHeight + roadOffset;
          y < canvas.height;
          y += lineHeight + lineGap
        ) {
          ctx.fillRect(canvas.width / 2 - 2, y, 4, lineHeight);
          ctx.fillRect(canvas.width / 2 - 60 - 2, y, 4, lineHeight);
          ctx.fillRect(canvas.width / 2 + 60 - 2, y, 4, lineHeight);
        }
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(canvas.width / 2 - 125, 0, 5, canvas.height);
        ctx.fillRect(canvas.width / 2 + 120, 0, 5, canvas.height);
      }

      function drawPlayer() {
        ctx.fillStyle = '#ff6600';
        ctx.fillRect(
          player.x + 2,
          player.y + 5,
          player.width - 4,
          player.height - 10
        );

        ctx.fillStyle = '#ff4400';
        ctx.fillRect(player.x + 4, player.y, player.width - 8, 8);
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(player.x + 6, player.y + 8, player.width - 12, 12);
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(player.x + 6, player.y + 25, player.width - 12, 10);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(player.x + 5, player.y + 2, 4, 3);
        ctx.fillRect(player.x + player.width - 9, player.y + 2, 4, 3);
        ctx.fillStyle = '#ff0000';
        ctx.fillRect(player.x + 5, player.y + player.height - 7, 4, 3);
        ctx.fillRect(
          player.x + player.width - 9,
          player.y + player.height - 7,
          4,
          3
        );

        ctx.fillStyle = '#222222';
        ctx.fillRect(player.x - 2, player.y + 10, 4, 8);
        ctx.fillRect(player.x + player.width - 2, player.y + 10, 4, 8);
        ctx.fillRect(player.x - 2, player.y + 32, 4, 8);
        ctx.fillRect(player.x + player.width - 2, player.y + 32, 4, 8);

        ctx.fillStyle = '#888888';
        ctx.fillRect(player.x - 1, player.y + 12, 2, 4);
        ctx.fillRect(player.x + player.width - 1, player.y + 12, 2, 4);
        ctx.fillRect(player.x - 1, player.y + 34, 2, 4);
        ctx.fillRect(player.x + player.width - 1, player.y + 34, 2, 4);

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(
          player.x + player.width / 2 - 1,
          player.y + 5,
          2,
          player.height - 10
        );

        if (player.boost) {
          ctx.fillStyle = '#ff0000';
          ctx.fillRect(player.x + 10, player.y + player.height, 4, 12);
          ctx.fillRect(player.x + 16, player.y + player.height, 4, 12);
          ctx.fillStyle = '#ffff00';
          ctx.fillRect(player.x + 11, player.y + player.height + 2, 2, 8);
          ctx.fillRect(player.x + 17, player.y + player.height + 2, 2, 8);
        }
      }

      function drawCars() {
        for (let car of cars) {
          ctx.fillStyle = car.color;
          ctx.fillRect(car.x + 2, car.y + 5, car.width - 4, car.height - 10);
          const roofColor =
            car.color === '#ff0000'
              ? '#cc0000'
              : car.color === '#0000ff'
              ? '#0000cc'
              : car.color === '#00ff00'
              ? '#00cc00'
              : car.color === '#ffff00'
              ? '#cccc00'
              : '#cc00cc';
          ctx.fillStyle = roofColor;
          ctx.fillRect(car.x + 4, car.y + 15, car.width - 8, 20);
          ctx.fillStyle = '#333333';
          ctx.fillRect(car.x + 6, car.y + 8, car.width - 12, 10);
          ctx.fillRect(car.x + 6, car.y + 37, car.width - 12, 8);
          ctx.fillStyle = '#666666';
          ctx.fillRect(car.x, car.y + 20, 2, 3);
          ctx.fillRect(car.x + car.width - 2, car.y + 20, 2, 3);
          ctx.fillStyle = '#ffffcc';
          ctx.fillRect(car.x + 5, car.y + 2, 4, 3);
          ctx.fillRect(car.x + car.width - 9, car.y + 2, 4, 3);
          ctx.fillStyle = '#ff4444';
          ctx.fillRect(car.x + 5, car.y + car.height - 7, 4, 3);
          ctx.fillRect(car.x + car.width - 9, car.y + car.height - 7, 4, 3);
          ctx.fillStyle = '#111111';
          ctx.fillRect(car.x - 2, car.y + 8, 4, 8);
          ctx.fillRect(car.x + car.width - 2, car.y + 8, 4, 8);
          ctx.fillRect(car.x - 2, car.y + 34, 4, 8);
          ctx.fillRect(car.x + car.width - 2, car.y + 34, 4, 8);
          ctx.fillStyle = '#555555';
          ctx.fillRect(car.x - 1, car.y + 10, 2, 4);
          ctx.fillRect(car.x + car.width - 1, car.y + 10, 2, 4);
          ctx.fillRect(car.x - 1, car.y + 36, 2, 4);
          ctx.fillRect(car.x + car.width - 1, car.y + 36, 2, 4);
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(car.x + 8, car.y + car.height - 5, 14, 4);
          ctx.fillStyle = '#000000';
          ctx.fillRect(car.x + 9, car.y + car.height - 4, 12, 2);
          ctx.fillStyle = '#888888';
          ctx.fillRect(car.x + 3, car.y, car.width - 6, 2);
          ctx.fillRect(car.x + 3, car.y + car.height - 2, car.width - 6, 2);
        }
      }

      function drawCoins() {
        for (let coin of coinItems) {
          ctx.save();
          ctx.translate(coin.x + coin.width / 2, coin.y + coin.height / 2);
          ctx.rotate(coin.rotation);
          ctx.fillStyle = '#ffdd00';
          ctx.fillRect(
            -coin.width / 2,
            -coin.height / 2,
            coin.width,
            coin.height
          );
          ctx.fillStyle = '#ffa500';
          ctx.fillRect(
            -coin.width / 2 + 3,
            -coin.height / 2 + 3,
            coin.width - 6,
            coin.height - 6
          );
          ctx.restore();
        }
      }

      function drawParticles() {
        for (let particle of particles) {
          const alpha = particle.life / particle.maxLife;
          ctx.globalAlpha = alpha;
          ctx.fillStyle = particle.color;
          ctx.fillRect(particle.x, particle.y, particle.size, particle.size);
        }
        ctx.globalAlpha = 1;
      }

      function drawUI() {
        document.getElementById('scoreValue').textContent = score;
        document.getElementById('coinsValue').textContent = coins;
        document.getElementById('speedValue').textContent = Math.floor(
          (player.speed +
            (player.boost ? player.speed * (player.boostPower - 1) : 0)) *
            20
        );
        const barWidth = 100;
        const barHeight = 8;
        const barX = canvas.width - barWidth - 20;
        const barY = canvas.height - 30;

        ctx.fillStyle = '#333333';
        ctx.fillRect(barX, barY, barWidth, barHeight);
        ctx.fillStyle = player.boostEnergy > 30 ? '#00ff00' : '#ff4444';
        ctx.fillRect(
          barX,
          barY,
          (player.boostEnergy / player.maxBoostEnergy) * barWidth,
          barHeight
        );
        ctx.fillStyle = '#ffffff';
        ctx.strokeRect(barX, barY, barWidth, barHeight);
        ctx.font = '12px Courier New';
        ctx.fillText('BOOST', barX, barY - 5);
      }
      function gameOver() {
        gameRunning = false;
        let newRecord = false;
        if (score > bestScore) {
          bestScore = score;
          localStorage.setItem('speedRacerBest', bestScore);
          newRecord = true;
        }
        localStorage.setItem('speedRacerCoins', totalCoins);

        if (currentUser && db && score > 0) {
          console.log('Attempting to submit Speed Racer score:', score);
          submitScore('speedracer', score);
        }
        showGameOverScreen(newRecord);
      }

      function restartGame() {
        gameRunning = true;

        const existingGameOver = document.getElementById('gameOverScreen');
        if (existingGameOver) {
          existingGameOver.remove();
        }

        document.getElementById('shopScreen').style.display = 'none';
        resetGame();
      }

      function pauseGame() {
        gameRunning = false;
      }

      function openShop() {
        document.getElementById('shopScreen').style.display = 'block';
        updateShopDisplay();
      }

      function closeShop() {
        document.getElementById('shopScreen').style.display = 'none';
        if (gameStarted) {
          gameRunning = true;
        }
      }

      function updateShopDisplay() {
        document.getElementById('shopCoins').textContent = totalCoins;
        document.getElementById('speedLevel').textContent = upgrades.speed;
        document.getElementById('handlingLevel').textContent =
          upgrades.handling;
        document.getElementById('boostLevel').textContent = upgrades.boost;
        const speedCost = 100 + (upgrades.speed - 1) * 50;
        const handlingCost = 150 + (upgrades.handling - 1) * 75;
        const boostCost = 200 + (upgrades.boost - 1) * 100;
        document.getElementById('speedBtn').textContent = `Buy (${speedCost})`;
        document.getElementById(
          'handlingBtn'
        ).textContent = `Buy (${handlingCost})`;
        document.getElementById('boostBtn').textContent = `Buy (${boostCost})`;
        document.getElementById('speedBtn').disabled = totalCoins < speedCost;
        document.getElementById('handlingBtn').disabled =
          totalCoins < handlingCost;
        document.getElementById('boostBtn').disabled = totalCoins < boostCost;
      }

      function buyUpgrade(type) {
        let cost;
        switch (type) {
          case 'speed':
            cost = 100 + (upgrades.speed - 1) * 50;
            break;
          case 'handling':
            cost = 150 + (upgrades.handling - 1) * 75;
            break;
          case 'boost':
            cost = 200 + (upgrades.boost - 1) * 100;
            break;
        }

        if (totalCoins >= cost) {
          totalCoins -= cost;
          upgrades[type]++;
          localStorage.setItem('speedRacerCoins', totalCoins);
          localStorage.setItem(
            `speedRacer${type.charAt(0).toUpperCase() + type.slice(1)}Level`,
            upgrades[type]
          );
          playUpgradeSound();
          updateShopDisplay();
          player.maxSpeed = 3 + upgrades.speed * 0.5;
          player.lateralSpeed = 4 + upgrades.handling * 0.5;
          player.boostPower = 1.5 + upgrades.boost * 0.3;
        }
      }

      function showGameOverScreen(newRecord) {
        const existingGameOver = document.getElementById('gameOverScreen');
        if (existingGameOver) {
          existingGameOver.remove();
        }

        const gameOverDiv = document.createElement('div');
        gameOverDiv.id = 'gameOverScreen';
        gameOverDiv.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.9);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          font-family: 'Courier New', monospace;
          color: white;
          z-index: 1000;
        `;

        gameOverDiv.innerHTML = `
          <h1 style="font-size: 4rem; color: #ff0000; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 3px;">RACE OVER</h1>
          <h2 style="font-size: 2rem; color: #00ff00; margin-bottom: 10px;">Final Score: ${score}</h2>
          <h3 style="font-size: 1.5rem; color: #ffff00; margin-bottom: 10px;">Distance: ${Math.floor(
            distance / 10
          )}m</h3>
          <h3 style="font-size: 1.5rem; color: #ffdd00; margin-bottom: 10px;">Coins Earned: ${coins}</h3>
          ${
            newRecord
              ? '<h3 style="font-size: 1.2rem; color: #00ff00; margin-bottom: 30px;">üèÜ NEW BEST SCORE! üèÜ</h3>'
              : '<div style="margin-bottom: 30px;"></div>'
          }
          <button id="playAgainBtn" style="
            background: black;
            color: white;
            border: 2px solid white;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
          ">üèéÔ∏è Race Again</button>
          <button id="shopBtn" style="
            background: black;
            color: white;
            border: 2px solid #ffdd00;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
          ">üîß Shop</button>
          <button id="backToMenuBtn" style="
            background: black;
            color: white;
            border: 2px solid white;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
          ">üè† Back to Menu</button>
          <button id="viewLeaderboardBtn" style="
            background: black;
            color: white;
            border: 2px solid #00ff00;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
          ">üèÜ View Leaderboard</button>
        `;

        document.body.appendChild(gameOverDiv);

        const playAgainBtn = document.getElementById('playAgainBtn');
        const shopBtn = document.getElementById('shopBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const viewLeaderboardBtn =
          document.getElementById('viewLeaderboardBtn');

        [playAgainBtn, shopBtn, backToMenuBtn, viewLeaderboardBtn].forEach(
          btn => {
            btn.addEventListener('mouseenter', () => {
              btn.style.background = 'white';
              btn.style.color = 'black';
            });
            btn.addEventListener('mouseleave', () => {
              btn.style.background = 'black';
              btn.style.color = 'white';
            });
          }
        );

        playAgainBtn.addEventListener('click', () => {
          document.body.removeChild(gameOverDiv);
          restartGame();
        });

        shopBtn.addEventListener('click', () => {
          document.body.removeChild(gameOverDiv);
          openShop();
        });

        backToMenuBtn.addEventListener('click', () => {
          window.location.href = 'index.html';
        });

        viewLeaderboardBtn.addEventListener('click', () => {
          window.location.href = 'index.html#leaderboard';
        });
      }

      async function submitScore(gameName, finalScore) {
        console.log('=== SPEED RACER SCORE SUBMISSION DEBUG ===');
        console.log('submitScore called with:', gameName, finalScore);
        console.log('Current user:', currentUser);
        console.log('Database available:', !!db);
        console.log('Auth state:', auth.currentUser);

        if (!currentUser || !db) {
          console.log(
            '‚ùå User not logged in or Firebase not available - score not submitted'
          );
          return;
        }

        try {
          console.log('‚úÖ Submitting Speed Racer score to Firebase...');
          const numericScore =
            typeof finalScore === 'number'
              ? finalScore
              : parseInt(finalScore) || 0;

          const scoreDoc = await db
            .collection('leaderboards')
            .doc(gameName)
            .collection('scores')
            .add({
              userId: currentUser.uid,
              username:
                currentUser.displayName || currentUser.email.split('@')[0],
              score: numericScore,
              distance: Math.floor(distance / 10),
              coins: coins,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });

          console.log('‚úÖ Speed Racer score document written:', scoreDoc.id);

          const userRef = db.collection('users').doc(currentUser.uid);
          const userDoc = await userRef.get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            const personalBests = userData.personalBests || {};
            if (
              !personalBests[gameName] ||
              numericScore > personalBests[gameName]
            ) {
              await userRef.update({
                [`personalBests.${gameName}`]: numericScore,
              });
              console.log(
                '‚úÖ Updated personal best for Speed Racer:',
                numericScore
              );
            }
          } else {
            await userRef.set({
              email: currentUser.email,
              username:
                currentUser.displayName || currentUser.email.split('@')[0],
              personalBests: {
                [gameName]: numericScore,
              },
            });
            console.log(
              '‚úÖ Created user document with Speed Racer score:',
              numericScore
            );
          }
          console.log('‚úÖ Speed Racer score submission completed successfully');
        } catch (error) {
          console.error('‚ùå Error submitting Speed Racer score:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);
        }
      }
      function gameLoop() {
        frameCount++;
        updatePlayer();
        updateCars();
        updateCoins();
        updateParticles();
        ctx.fillStyle = '#228B22';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawRoad();
        drawCars();
        drawCoins();
        drawPlayer();
        drawParticles();
        drawUI();
        requestAnimationFrame(gameLoop);
      }

      document.getElementById('bestValue').textContent = bestScore;
      document.getElementById('coinsValue').textContent = totalCoins;
      gameLoop();
      document.addEventListener('click', initAudio, { once: true });
      document.addEventListener('keydown', initAudio, { once: true });
    </script>
  </body>
</html>
