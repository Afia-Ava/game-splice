<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snake Classic - Game Hub</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        background: #000000;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-family: 'Courier New', monospace;
        color: white;
        position: relative;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        box-sizing: border-box;
      }

      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(255, 255, 255, 0.03) 2px,
          rgba(255, 255, 255, 0.03) 4px
        );
        pointer-events: none;
        z-index: 1000;
      }

      #gameCanvas {
        border: 3px solid white;
        background: #000000;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      }

      .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        background: black;
        color: white;
        border: 2px solid white;
        padding: 8px 16px;
        border-radius: 0;
        font-size: 12px;
        font-weight: 900;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-family: 'Courier New', monospace;
        z-index: 1000;
      }

      .game-info {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-family: 'Courier New', monospace;
        width: 220px;
        max-width: calc(100vw - 450px);
        z-index: 1000;
      }

      .score {
        font-size: 16px;
        color: white;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 2px solid white;
        padding: 15px 20px;
        background: rgba(0, 0, 0, 0.8);
        text-align: left;
      }

      .controls {
        font-size: 11px;
        opacity: 0.9;
        font-family: 'Courier New', monospace;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: #ccc;
        line-height: 1.4;
        border: 1px solid #666;
        padding: 15px 20px;
        background: rgba(0, 0, 0, 0.6);
        text-align: left;
      }

      .user-status {
        font-size: 12px;
        color: #00ff00;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 2px solid #00ff00;
        padding: 10px 15px;
        background: rgba(0, 0, 0, 0.8);
        text-align: center;
      }

      .user-status.not-logged-in {
        color: #ff6666;
        border-color: #ff6666;
      }
    </style>
  </head>
  <body>
    <a href="index.html" class="back-button">Back</a>
    <canvas id="gameCanvas" width="500" height="500"></canvas>
    <div class="game-info">
      <div class="score">Score: <span id="score">0</span></div>
      <div id="userStatus" class="user-status not-logged-in">Not Logged In</div>
      <div class="controls">
        Press any arrow key to start!<br />
        Use arrow keys to move<br />
        • Eat white food<br />
        • Don't hit walls or yourself!
      </div>
    </div>

    <script>
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const scoreElement = document.getElementById('score');
      let audioContext;
      let masterGain;
      function initAudio() {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          masterGain = audioContext.createGain();
          masterGain.gain.value = 0.3;
          masterGain.connect(audioContext.destination);
        }
      }

      function playMoveSound() {
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(180, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(
          160,
          audioContext.currentTime + 0.03
        );

        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.03
        );

        oscillator.connect(gainNode);
        gainNode.connect(masterGain);

        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.03);
      }

      function playEatSound() {
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(
          800,
          audioContext.currentTime + 0.1
        );
        oscillator.frequency.exponentialRampToValueAtTime(
          600,
          audioContext.currentTime + 0.2
        );

        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.2
        );

        oscillator.connect(gainNode);
        gainNode.connect(masterGain);

        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.2);
      }

      function playGameOverSound() {
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(
          100,
          audioContext.currentTime + 0.8
        );

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(
          0.01,
          audioContext.currentTime + 0.8
        );

        oscillator.connect(gainNode);
        gainNode.connect(masterGain);

        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.8);
      }

      function playStartSound() {
        initAudio();
        const frequencies = [262, 330, 392, 523];
        frequencies.forEach((freq, index) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(
            freq,
            audioContext.currentTime + index * 0.1
          );
          gainNode.gain.setValueAtTime(
            0.15,
            audioContext.currentTime + index * 0.1
          );
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + index * 0.1 + 0.2
          );
          oscillator.connect(gainNode);
          gainNode.connect(masterGain);
          oscillator.start(audioContext.currentTime + index * 0.1);
          oscillator.stop(audioContext.currentTime + index * 0.1 + 0.2);
        });
      }

      const gridSize = 20;
      const tileCount = canvas.width / gridSize;
      let snake = [{ x: 10, y: 10 }];
      let food = {};
      let dx = 0;
      let dy = 0;
      let score = 0;
      let gameRunning = false;
      let gameInterval;

      function randomFood() {
        food = {
          x: Math.floor(Math.random() * tileCount),
          y: Math.floor(Math.random() * tileCount),
        };
      }

      function drawGame() {
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        for (let x = 0; x <= canvas.width; x += gridSize) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height);
          ctx.stroke();
        }
        for (let y = 0; y <= canvas.height; y += gridSize) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        }

        snake.forEach((part, index) => {
          const x = part.x * gridSize;
          const y = part.y * gridSize;
          const size = gridSize - 2;

          if (index === 0) {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x, y, size, size);
            ctx.fillStyle = '#000000';
            let eyeSize = 3;
            let eyeOffset = 4;

            if (dx === 1) {
              ctx.fillRect(
                x + size - eyeOffset,
                y + eyeOffset,
                eyeSize,
                eyeSize
              );
              ctx.fillRect(
                x + size - eyeOffset,
                y + size - eyeOffset - eyeSize,
                eyeSize,
                eyeSize
              );
            } else if (dx === -1) {
              ctx.fillRect(x + 2, y + eyeOffset, eyeSize, eyeSize);
              ctx.fillRect(
                x + 2,
                y + size - eyeOffset - eyeSize,
                eyeSize,
                eyeSize
              );
            } else if (dy === 1) {
              ctx.fillRect(
                x + eyeOffset,
                y + size - eyeOffset,
                eyeSize,
                eyeSize
              );
              ctx.fillRect(
                x + size - eyeOffset - eyeSize,
                y + size - eyeOffset,
                eyeSize,
                eyeSize
              );
            } else if (dy === -1) {
              ctx.fillRect(x + eyeOffset, y + 2, eyeSize, eyeSize);
              ctx.fillRect(
                x + size - eyeOffset - eyeSize,
                y + 2,
                eyeSize,
                eyeSize
              );
            }

            ctx.strokeStyle = '#888888';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, size, size);
          } else {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x, y, size, size);

            if (index % 2 === 0) {
              ctx.fillStyle = '#cccccc';
              ctx.fillRect(x + 2, y + 2, size - 4, size - 4);
            }

            ctx.strokeStyle = '#666666';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, size, size);
          }
        });

        const foodX = food.x * gridSize;
        const foodY = food.y * gridSize;
        const foodSize = gridSize - 2;
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(
          foodX + foodSize / 2,
          foodY + foodSize / 2,
          foodSize / 2 - 2,
          0,
          2 * Math.PI
        );
        ctx.fill();
        ctx.fillStyle = '#cccccc';
        ctx.fillRect(foodX + foodSize / 2 - 1, foodY + 2, 2, 4);
        ctx.fillStyle = '#888888';
        ctx.beginPath();
        ctx.arc(
          foodX + foodSize / 2 - 3,
          foodY + foodSize / 2 - 3,
          2,
          0,
          2 * Math.PI
        );
        ctx.fill();

        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(
          foodX + foodSize / 2,
          foodY + foodSize / 2,
          foodSize / 2 - 2,
          0,
          2 * Math.PI
        );
        ctx.stroke();
      }

      function moveSnake() {
        const head = { x: snake[0].x + dx, y: snake[0].y + dy };
        if (
          head.x < 0 ||
          head.x >= tileCount ||
          head.y < 0 ||
          head.y >= tileCount
        ) {
          gameOver();
          return;
        }
        if (snake.some(part => part.x === head.x && part.y === head.y)) {
          gameOver();
          return;
        }
        snake.unshift(head);

        if (dx !== 0 || dy !== 0) {
          playMoveSound();
        }

        if (head.x === food.x && head.y === food.y) {
          score += 10;
          scoreElement.textContent = score;
          playEatSound();
          randomFood();
        } else {
          snake.pop();
        }
      }

      function gameOver() {
        console.log('Game Over! Final score:', score);
        clearInterval(gameInterval);
        gameRunning = false;
        playGameOverSound();

        if (score > 0) {
          console.log('Attempting to submit score:', score);
          submitScore('snake', score);
        }

        showGameOverScreen();
      }

      function showGameOverScreen() {
        const gameOverDiv = document.createElement('div');
        gameOverDiv.id = 'gameOverScreen';
        gameOverDiv.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.9);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          font-family: 'Courier New', monospace;
          color: white;
          z-index: 1000;
        `;

        gameOverDiv.innerHTML = `
          <h1 style="font-size: 4rem; color: #ff0000; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 3px;">GAME OVER</h1>
          <h2 style="font-size: 2rem; color: #00ff00; margin-bottom: 30px;">Final Score: ${score}</h2>
          <button id="playAgainBtn" style="
            background: black;
            color: white;
            border: 2px solid white;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
          ">Play Again</button>
          <button id="backToMenuBtn" style="
            background: black;
            color: white;
            border: 2px solid white;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
          ">Back to Menu</button>
          <button id="viewLeaderboardBtn" style="
            background: black;
            color: white;
            border: 2px solid #00ff00;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
          ">🏆 View Leaderboard</button>
        `;

        document.body.appendChild(gameOverDiv);

        const playAgainBtn = document.getElementById('playAgainBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const viewLeaderboardBtn =
          document.getElementById('viewLeaderboardBtn');

        [playAgainBtn, backToMenuBtn, viewLeaderboardBtn].forEach(btn => {
          btn.addEventListener('mouseenter', () => {
            btn.style.background = 'white';
            btn.style.color = 'black';
          });
          btn.addEventListener('mouseleave', () => {
            btn.style.background = 'black';
            btn.style.color = 'white';
          });
        });

        playAgainBtn.addEventListener('click', () => {
          document.body.removeChild(gameOverDiv);
          resetGame();
          startGame();
        });

        backToMenuBtn.addEventListener('click', () => {
          window.location.href = 'index.html';
        });

        viewLeaderboardBtn.addEventListener('click', () => {
          window.location.href = 'index.html#leaderboard';
        });
      }

      function resetGame() {
        snake = [{ x: 10, y: 10 }];
        dx = 0;
        dy = 0;
        score = 0;
        scoreElement.textContent = score;
        randomFood();
        gameRunning = false;
      }

      async function submitScore(gameName, finalScore) {
        console.log('=== SCORE SUBMISSION DEBUG ===');
        console.log('submitScore called with:', gameName, finalScore);
        console.log('Current user:', currentUser);
        console.log('Database available:', !!db);
        console.log('Auth state:', auth.currentUser);

        if (!currentUser || !db) {
          console.log(
            '❌ User not logged in or Firebase not available - score not submitted'
          );
          return;
        }

        try {
          console.log('✅ Submitting score to Firebase...');

          // Always submit the score (no checking for better scores)
          const numericScore =
            typeof finalScore === 'number'
              ? finalScore
              : parseInt(finalScore) || 0;

          const scoreDoc = await db
            .collection('leaderboards')
            .doc(gameName)
            .collection('scores')
            .add({
              userId: currentUser.uid,
              username:
                currentUser.displayName || currentUser.email.split('@')[0],
              score: numericScore,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });

          console.log('✅ Score document written:', scoreDoc.id);

          // Update user's personal best if this score is higher
          const userRef = db.collection('users').doc(currentUser.uid);
          const userDoc = await userRef.get();

          if (userDoc.exists) {
            const userData = userDoc.data();
            const personalBests = userData.personalBests || {};

            if (
              !personalBests[gameName] ||
              numericScore > personalBests[gameName]
            ) {
              personalBests[gameName] = numericScore;
              await userRef.update({ personalBests: personalBests });
              console.log('✅ Personal best updated to:', numericScore);
            }
          } else {
            // Create user document if it doesn't exist
            await userRef.set({
              personalBests: { [gameName]: numericScore },
            });
            console.log(
              '✅ New user document created with personal best:',
              numericScore
            );
          }

          console.log('✅ Score submitted successfully:', numericScore);
        } catch (error) {
          console.error('❌ Error submitting score:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);
        }
      }

      function gameLoop() {
        if (!gameRunning) return;
        moveSnake();
        drawGame();
      }

      function startGame() {
        if (gameRunning) return;
        gameRunning = true;
        gameInterval = setInterval(gameLoop, 150);
      }

      document.addEventListener('keydown', e => {
        if (!gameRunning) {
          startGame();
        }

        switch (e.key) {
          case 'ArrowUp':
            if (dy !== 1) {
              dx = 0;
              dy = -1;
            }
            break;
          case 'ArrowDown':
            if (dy !== -1) {
              dx = 0;
              dy = 1;
            }
            break;
          case 'ArrowLeft':
            if (dx !== 1) {
              dx = -1;
              dy = 0;
            }
            break;
          case 'ArrowRight':
            if (dx !== -1) {
              dx = 1;
              dy = 0;
            }
            break;
        }
      });

      randomFood();
      drawGame();

      document.addEventListener('click', initAudio, { once: true });
      document.addEventListener('keydown', initAudio, { once: true });

      let auth,
        db,
        currentUser = null;
      const userStatusElement = document.getElementById('userStatus');

      if (typeof window.firebaseConfig !== 'undefined') {
        try {
          firebase.initializeApp(window.firebaseConfig);
          auth = firebase.auth();
          db = firebase.firestore();

          auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUserStatus();
          });

          console.log('Firebase initialized in Snake game');
        } catch (error) {
          console.error('Firebase initialization error in Snake game:', error);
        }
      } else {
        console.log('Firebase config not available in Snake game');
      }

      function updateUserStatus() {
        if (currentUser) {
          userStatusElement.textContent = `Logged in: ${
            currentUser.displayName || currentUser.email.split('@')[0]
          }`;
          userStatusElement.className = 'user-status';
        } else {
          userStatusElement.textContent = "Not Logged In - Scores Won't Save";
          userStatusElement.className = 'user-status not-logged-in';
        }
      }
    </script>
  </body>
</html>
